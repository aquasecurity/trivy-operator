package vulnerabilityreport_test

import (
	"sort"
	"testing"

	"github.com/stretchr/testify/assert"

	"github.com/aquasecurity/trivy-operator/pkg/apis/aquasecurity/shared"
	"github.com/aquasecurity/trivy-operator/pkg/apis/aquasecurity/v1beta1"
	"github.com/aquasecurity/trivy-operator/pkg/vulnerabilityreport"
)

func TestBySeverity(t *testing.T) {
	items := []v1beta1.Vulnerability{
		{VulnerabilityID: "CVE-0000-0001", Severity: shared.SeverityLow},
		{VulnerabilityID: "CVE-0000-0002", Severity: shared.SeverityMedium},
		{VulnerabilityID: "CVE-0000-0003", Severity: shared.SeverityMedium},
		{VulnerabilityID: "CVE-0000-0004", Severity: shared.SeverityCritical},
		{VulnerabilityID: "CVE-0000-0005", Severity: shared.SeverityHigh},
		{VulnerabilityID: "CVE-0000-0006", Severity: shared.SeverityHigh},
	}

	sort.Stable(vulnerabilityreport.BySeverity{Vulnerabilities: items})

	assert.Equal(t, []v1beta1.Vulnerability{
		{VulnerabilityID: "CVE-0000-0004", Severity: shared.SeverityCritical},
		{VulnerabilityID: "CVE-0000-0005", Severity: shared.SeverityHigh},
		{VulnerabilityID: "CVE-0000-0006", Severity: shared.SeverityHigh},
		{VulnerabilityID: "CVE-0000-0002", Severity: shared.SeverityMedium},
		{VulnerabilityID: "CVE-0000-0003", Severity: shared.SeverityMedium},
		{VulnerabilityID: "CVE-0000-0001", Severity: shared.SeverityLow},
	}, items)

}

func TestOrderedBy(t *testing.T) {
	reports := []v1beta1.VulnerabilityReport{
		{
			Report: v1beta1.VulnerabilityReportData{
				Artifact: shared.Artifact{
					Repository: "nginx",
				},
				Summary: shared.VulnerabilitySummary{
					CriticalCount: 3,
					HighCount:     12,
					MediumCount:   58,
					LowCount:      7,
					UnknownCount:  1,
				},
			},
		},
		{
			Report: v1beta1.VulnerabilityReportData{
				Artifact: shared.Artifact{
					Repository: "wordpress",
				},
				Summary: shared.VulnerabilitySummary{
					CriticalCount: 7,
					HighCount:     12,
					MediumCount:   1,
					LowCount:      20,
					UnknownCount:  2,
				},
			},
		},
		{
			Report: v1beta1.VulnerabilityReportData{
				Artifact: shared.Artifact{
					Repository: "mysql",
				},
				Summary: shared.VulnerabilitySummary{
					CriticalCount: 3,
					HighCount:     2,
					MediumCount:   1,
					LowCount:      7,
					UnknownCount:  3,
				},
			},
		},
		{
			Report: v1beta1.VulnerabilityReportData{
				Artifact: shared.Artifact{
					Repository: "postgresql",
				},
				Summary: shared.VulnerabilitySummary{
					CriticalCount: 89,
					HighCount:     0,
					MediumCount:   1,
					LowCount:      3,
					UnknownCount:  2,
				},
			},
		},
		{
			Report: v1beta1.VulnerabilityReportData{
				Artifact: shared.Artifact{
					Repository: "jenkins",
				},
				Summary: shared.VulnerabilitySummary{
					CriticalCount: 0,
					HighCount:     0,
					MediumCount:   1,
					LowCount:      7,
					UnknownCount:  3,
				},
			},
		},
	}
	vulnerabilityreport.OrderedBy(vulnerabilityreport.SummaryCount...).SortDesc(reports)
	assert.Equal(t, []v1beta1.VulnerabilityReport{
		{
			Report: v1beta1.VulnerabilityReportData{
				Artifact: shared.Artifact{
					Repository: "postgresql",
				},
				Summary: shared.VulnerabilitySummary{
					CriticalCount: 89,
					HighCount:     0,
					MediumCount:   1,
					LowCount:      3,
					UnknownCount:  2,
				},
			},
		},
		{
			Report: v1beta1.VulnerabilityReportData{
				Artifact: shared.Artifact{
					Repository: "wordpress",
				},
				Summary: shared.VulnerabilitySummary{
					CriticalCount: 7,
					HighCount:     12,
					MediumCount:   1,
					LowCount:      20,
					UnknownCount:  2,
				},
			},
		},
		{
			Report: v1beta1.VulnerabilityReportData{
				Artifact: shared.Artifact{
					Repository: "nginx",
				},
				Summary: shared.VulnerabilitySummary{
					CriticalCount: 3,
					HighCount:     12,
					MediumCount:   58,
					LowCount:      7,
					UnknownCount:  1,
				},
			},
		},
		{
			Report: v1beta1.VulnerabilityReportData{
				Artifact: shared.Artifact{
					Repository: "mysql",
				},
				Summary: shared.VulnerabilitySummary{
					CriticalCount: 3,
					HighCount:     2,
					MediumCount:   1,
					LowCount:      7,
					UnknownCount:  3,
				},
			},
		},
		{
			Report: v1beta1.VulnerabilityReportData{
				Artifact: shared.Artifact{
					Repository: "jenkins",
				},
				Summary: shared.VulnerabilitySummary{
					CriticalCount: 0,
					HighCount:     0,
					MediumCount:   1,
					LowCount:      7,
					UnknownCount:  3,
				},
			},
		},
	}, reports)
}
