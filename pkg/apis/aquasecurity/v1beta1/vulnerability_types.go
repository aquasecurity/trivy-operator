package v1beta1

import (
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"

	"github.com/aquasecurity/trivy-db/pkg/types"

	"github.com/aquasecurity/trivy-operator/pkg/apis/aquasecurity/shared"
)

// Vulnerability is the spec for a vulnerability record.
type Vulnerability struct {
	// VulnerabilityID the vulnerability identifier.
	VulnerabilityID string `json:"vulnerabilityID"`

	// Resource is a vulnerable package, application, or library.
	Resource string `json:"resource,omitempty"`

	// InstalledVersion indicates the installed version of the Resource.
	InstalledVersion string `json:"installedVersion,omitempty"`

	// FixedVersion indicates the version of the Resource in which this vulnerability has been fixed.
	FixedVersion string `json:"fixedVersion,omitempty"`
	// PublishedDate indicates the date of published CVE.
	PublishedDate string `json:"publishedDate,omitempty"`
	// LastModifiedDate indicates the last date CVE has been modified.
	LastModifiedDate string `json:"lastModifiedDate,omitempty"`
	// Severity level of a vulnerability or a configuration audit check.
	// +kubebuilder:validation:Enum={CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN}
	Severity    shared.Severity `json:"severity"`
	Title       string          `json:"title,omitempty"`
	Description string          `json:"description,omitempty"`
	CVSSSource  string          `json:"cvsssource,omitempty"`
	PrimaryLink string          `json:"primaryLink,omitempty"`
	// +optional
	Links []string `json:"links,omitempty"`
	Score *float64 `json:"score,omitempty"`
	// +optional
	Target string `json:"target,omitempty"`
	// +optional
	CVSS types.VendorCVSS `json:"cvss,omitempty"`
	// +optional
	Class       string `json:"class,omitempty"`
	PackageType string `json:"packageType,omitempty"`
	PkgPath     string `json:"packagePath,omitempty"`
	PkgPURL     string `json:"packagePURL,omitempty"`
}

// +kubebuilder:object:root=true
// +kubebuilder:storageversion
// +kubebuilder:pruning:PreserveUnknownFields
// +kubebuilder:resource:shortName={vuln,vulns}
// +kubebuilder:printcolumn:name="Repository",type=string,JSONPath=`.report.artifact.repository`,description="The name of image repository"
// +kubebuilder:printcolumn:name="Tag",type=string,JSONPath=`.report.artifact.tag`,description="The name of image tag"
// +kubebuilder:printcolumn:name="Scanner",type=string,JSONPath=`.report.scanner.name`,description="The name of the vulnerability scanner"
// +kubebuilder:printcolumn:name="Age",type=date,JSONPath=`.metadata.creationTimestamp`,description="The age of the report"
// +kubebuilder:printcolumn:name="Critical",type=integer,JSONPath=`.report.summary.criticalCount`,priority=1,description="The number of critical vulnerabilities"
// +kubebuilder:printcolumn:name="High",type=integer,JSONPath=`.report.summary.highCount`,priority=1,description="The number of high vulnerabilities"
// +kubebuilder:printcolumn:name="Medium",type=integer,JSONPath=`.report.summary.mediumCount`,priority=1,description="The number of medium vulnerabilities"
// +kubebuilder:printcolumn:name="Low",type=integer,JSONPath=`.report.summary.lowCount`,priority=1,description="The number of low vulnerabilities"
// +kubebuilder:printcolumn:name="Unknown",type=integer,JSONPath=`.report.summary.unknownCount`,priority=1,description="The number of unknown vulnerabilities"

// VulnerabilityReport summarizes vulnerabilities in application dependencies and operating system packages
// built into container images.
type VulnerabilityReport struct {
	metav1.TypeMeta   `json:",inline"`
	metav1.ObjectMeta `json:"metadata,omitempty"`

	// Report is the actual vulnerability report data.
	Report VulnerabilityReportData `json:"report"`
}

// +kubebuilder:object:root=true
// +kubebuilder:storageversion
// +kubebuilder:pruning:PreserveUnknownFields
// +kubebuilder:resource:scope=Cluster,shortName={clustervuln}
// +kubebuilder:printcolumn:name="Repository",type=string,JSONPath=`.report.artifact.repository`,description="The name of image repository"
// +kubebuilder:printcolumn:name="Tag",type=string,JSONPath=`.report.artifact.tag`,description="The name of image tag"
// +kubebuilder:printcolumn:name="Scanner",type=string,JSONPath=`.report.scanner.name`,description="The name of the vulnerability scanner"
// +kubebuilder:printcolumn:name="Age",type=date,JSONPath=`.metadata.creationTimestamp`,description="The age of the report"
// +kubebuilder:printcolumn:name="Critical",type=integer,JSONPath=`.report.summary.criticalCount`,priority=1,description="The number of critical vulnerabilities"
// +kubebuilder:printcolumn:name="High",type=integer,JSONPath=`.report.summary.highCount`,priority=1,description="The number of high vulnerabilities"
// +kubebuilder:printcolumn:name="Medium",type=integer,JSONPath=`.report.summary.mediumCount`,priority=1,description="The number of medium vulnerabilities"
// +kubebuilder:printcolumn:name="Low",type=integer,JSONPath=`.report.summary.lowCount`,priority=1,description="The number of low vulnerabilities"
// +kubebuilder:printcolumn:name="Unknown",type=integer,JSONPath=`.report.summary.unknownCount`,priority=1,description="The number of unknown vulnerabilities"

// ClusterVulnerabilityReport summarizes vulnerabilities in application dependencies and operating system packages
// built into container images.
type ClusterVulnerabilityReport struct {
	metav1.TypeMeta   `json:",inline"`
	metav1.ObjectMeta `json:"metadata,omitempty"`

	// Report is the actual vulnerability report data.
	Report VulnerabilityReportData `json:"report"`
}

// VulnerabilityReportData is the spec for the vulnerability scan result.
//
// The spec follows the Pluggable Scanners API defined for Harbor.
// @see https://github.com/goharbor/pluggable-scanner-spec/blob/master/api/spec/scanner-adapter-openapi-v1.0.yaml
type VulnerabilityReportData struct {
	// UpdateTimestamp is a timestamp representing the server time in UTC when this report was updated.
	// +kubebuilder:validation:Type=string
	// +kubebuilder:validation:Format=date-time
	UpdateTimestamp metav1.Time `json:"updateTimestamp"`

	// Scanner is the scanner that generated this report.
	Scanner shared.Scanner `json:"scanner"`

	// Registry is the registry the Artifact was pulled from.
	// +optional
	Registry shared.Registry `json:"registry"`

	// Artifact represents a standalone, executable package of software that includes everything needed to
	// run an application.
	Artifact shared.Artifact `json:"artifact"`

	// OS information of the artifact
	OS shared.OS `json:"os"`

	// Summary is a summary of Vulnerability counts grouped by Severity.
	Summary shared.VulnerabilitySummary `json:"summary"`

	// Vulnerabilities is a list of operating system (OS) or application software Vulnerability items found in the Artifact.
	Vulnerabilities []Vulnerability `json:"vulnerabilities"`
}

// +kubebuilder:object:root=true

// VulnerabilityReportList is a list of VulnerabilityReport resources.
type VulnerabilityReportList struct {
	metav1.TypeMeta `json:",inline"`
	metav1.ListMeta `json:"metadata"`

	// Vulnerability is the spec for a vulnerability record.
	Items []VulnerabilityReport `json:"items"`
}

// +kubebuilder:object:root=true

// ClusterVulnerabilityReportList is a list of VulnerabilityReport resources.
type ClusterVulnerabilityReportList struct {
	metav1.TypeMeta `json:",inline"`
	metav1.ListMeta `json:"metadata"`

	// ClusterVulnerability is the spec for a cluster vulnerability record.
	Items []ClusterVulnerabilityReport `json:"items"`
}
